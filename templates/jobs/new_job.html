{% extends "jobs/base.html" %}
{% load bootstrap %}
{% load widget_tweaks %}
{% load wysiwyg %}
{% load markdownify %}
{% block content %}
	<div class="post whiteboard">
		<div class="panel panel-default">
			<div class="panel-heading">
				{% if form.instance.pk %}
					<h2 class="panel-page-title">Edit Job</h2>
				{% else %}
					<h2 class="panel-page-title">Post a Job</h2>
				{% endif %}
				<p>
					For help,
					<a href="#">click here</a>
				</p>
			</div>
			<form id="post" name="post" action="" method="post" class="form-horizontal">{% csrf_token %}
				{% wysiwyg_setup %}
				<div class="panel-body">

					<div class="input-block">
						<div class="form-group {% if form.title.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.title.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.title|attr:'required:true'}}
								<p class="help-block">Enter a descriptive title for the job listing.</p>
								<div class="help-block with-errors"></div>
							</div>
						</div>
					</div>

					<div class="input-block">
						<div class="form-group {% if form.category.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.category.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.category|attr:'required:true'}}
								<p class="help-block">Select a category that best suits the job listing.</p>
								<div class="help-block with-errors"></div>
							</div>
						</div>

						{% wysiwyg_editor "id_description" %}
						<div class="form-group {% if form.description.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.description.label_tag }}</label>
							<div class="col-sm-10">
								<textarea class="validation" cols="40" id="{{form.description.id_for_label}}" name="{{form.description.html_name}}" required="true" rows="10">{{form.description.value|markdownify}}</textarea>
								<p class="help-block">Fill in as much detail as you can about the position, outlining responsibilities, perks and information about your company.</p>
								<div class="help-block with-errors"></div>
							</div>
						</div>
					</div>

					<div class="input-block">
						<div class="form-group {% if form.position.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.position.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.position|attr:'required:true' }}
								<div class="help-block with-errors"></div>
							</div>
						</div>
						<div class="form-group {% if form.remote.error %} has error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.remote.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.remote|attr:'required:true' }}
								<p class="help-block">Can this job be worked on from a remote location?</p>
								<div class="help-block with-errors"></div>
							</div>

						</div>
					</div>

					<div class="input-block">
						<div class="form-group {% if form.region.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.region.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.region|attr:'required:true' }}
								<div class="help-block with-errors"></div>
							</div>
						</div>

						<div class="form-group {% if form.city.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.city.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.city|attr:'required:true' }}
								<div class="help-block with-errors"></div>
							</div>
						</div>
					</div>

					<div class="input-block">
						<div class="form-group {% if form.type.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.type.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.type|attr:'required:true' }}
								<div class="help-block with-errors"></div>
							</div>
						</div>
					</div>

					<div class="input-block">
						<div class="form-group {% if form.budget.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.budget.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.budget|attr:'required:true'|attr:'type:number'|attr:'step:any' }}
								<p class="help-block">Enter in the budget/wage for this job.</p>
								<div class="help-block with-errors"></div>
							</div>
						</div>
					</div>

					<div class="input-block">
						<div class="form-group {% if form.expires.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.expires.label_tag }}</label>
							<div class='col-sm-10'>
								{{ form.expires|attr:'required:true' }}
								<div class="help-block with-errors"></div>
							</div>
						</div>

						<div class="form-group {% if form.tag_list.errors %} has-error {% endif %}">
							<label for="inputEmail3" class="col-sm-2 control-label">{{ form.tag_list.label_tag }}</label>
							<div class="col-sm-10">
								{{ form.tag_list|attr:'required:true' }}
								<p class="help-block">Comma seperated tags describing this job.</p>
								<div class="help-block with-errors"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="panel-footer clearfix">
					<input id="jobsubmit" name="jobsubmit" type="submit" value="Submit Listing" class="btn btn-primary pull-right"/>
				</div>
			</form>
		</div>
	</div>

	<script type="text/javascript">
		$(document).ready(function () {
			$('#id_category, #id_position, #id_type, #id_budget_type').chosen({disable_search_threshold: 10});
			$('#id_remote').chosen({disable_search_threshold: 10});
			$('#id_region').chosen({disable_search_threshold: 10});
			$('#id_city').chosen({disable_search_threshold: 10});
			$('#id_tag_list').tagsinput({tagClass: 'label label-info job_tag_label'});
		});

		if (!Modernizr.touchevents || !Modernizr.inputtypes.date) {
			$('.datepicker').prop('type', 'text');
			$('.datepicker').datepicker();
		} else {}

		$(document).ready(function () {
			$.fn.validator.Constructor.INPUT_SELECTOR += ':not(.chosen-search input)'
			$("#post").validator();
			$('#id_region').on('change', function (evt, params) {
				val = this.value;
				$.post("/new/region", {
					id: val,
					'csrfmiddlewaretoken': '{{ csrf_token }}'
				}, function (data) {
					$('#id_city').find('option').remove().end();
					var rawCities = data.split('|');
					rawCities.pop();
					$('#id_city').append('<option value="" selected="selected">---------</option>');
					$.each(rawCities, function (index, value) {
						rawCity = value.split(':');
						$('#id_city').append('<option value="' + rawCity[0] + '">' + rawCity[1] + '</option>');
					});
					$("#id_city").trigger("chosen:updated");
				});
			});

			$('#post').validator().on('submit', function (e) {
				if (e.isDefaultPrevented()) {
					// handle the invalid form...
				} else {
					var dataArray = $("#post").serializeArray(),
						len = dataArray.length,
						dataObj = {};

					for (i = 0; i < len; i++) {
						dataObj[dataArray[i].name] = dataArray[i].value;
					}
					var options = {
						link_list: false, // render links as references, create link list as appendix
						h1_setext: false, // underline h1 headers
						h2_setext: false, // underline h2 headers
						h_atx_suf: true, // header suffixes (###)
						gfm_code: "```", // gfm code blocks
						trim_code: false, // trim whitespace within <pre><code> blocks (full block, not per line)
						li_bullet: "*", // list item bullet style
						hr_char: "-", // hr style
						indnt_str: "    ", // indentation string
						bold_char: "*", // char used for strong
						emph_char: "_", // char used for em
						gfm_del: true, // ~~strikeout~~ for <del>strikeout</del>
						gfm_tbls: true, // markdown-extra tables
						tbl_edges: false, // show side edges on tables
						hash_lnks: false, // anchors w/hash hrefs as links
						br_only: false, // avoid using "  " as line break indicator
						col_pre: "col ", // column prefix to use when creating missing headers for tables
						nbsp_spc: true, // convert &nbsp; entities in html to regular spaces
						span_tags: true, // output spans (ambiguous) using html tags
						div_tags: true, // output divs (ambiguous) using html tags
						unsup_tags: { // handling of unsupported tags, defined in terms of desired output style. if not listed, output = outerHTML
							// no output
							ignore: "script style noscript",
							// eg: "<tag>some content</tag>"
							inline: "span sup sub i u b center big",
							// eg: "\n\n<tag>\n\tsome content\n</tag>"
							block2: "div form fieldset dl header footer address article aside figure hgroup section",
							// eg: "\n<tag>some content</tag>"
							block1c: "dt dd caption legend figcaption output",
							// eg: "\n\n<tag>some content</tag>"
							block2c: "canvas audio video iframe"
						},
						tag_remap: { // remap of variants or deprecated tags to internal classes
							"i": "em",
							"b": "strong"
						}
					};
					var reMarker = new reMarked();
					var markdown = reMarker.render(dataObj.description);
					dataObj.description = markdown;
					$.post(window.location, dataObj).done(function functionName() {
						window.location = '/';
					});
					return false;
				}
			})

		});
	</script>
{% endblock %}
